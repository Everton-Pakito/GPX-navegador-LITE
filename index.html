<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GPX Navigator - M√∫ltiplos Arquivos</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
        font-family: sans-serif;
        background: #eef;
        margin: 0;
        padding: 20px;
    }
    .container {
        max-width: 800px;
        margin: auto;
    }
    .section {
        background: white;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    ul { 
        list-style: none; 
        padding: 0; 
    }
    .list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding: 10px;
        background: #f0f0f0;
        border-radius: 6px;
    }
    .btn {
        padding: 6px 12px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }
    .btn:hover {
        background: #2980b9;
    }
    .btn:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
    }
    .text-center {
        text-align: center;
    }
    .error {
        color: #e74c3c;
        background: #fadbd8;
        padding: 10px;
        border-radius: 6px;
        margin: 10px 0;
    }
    .success {
        color: #27ae60;
        background: #d5f4e6;
        padding: 10px;
        border-radius: 6px;
        margin: 10px 0;
    }
    #gpxInput {
        width: 100%;
        padding: 10px;
        border: 2px dashed #3498db;
        border-radius: 6px;
        background: #f8f9fa;
        cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üó∫Ô∏è GPX Navigator</h1>

    <div class="section">
      <h2>üìÇ Subir Arquivos GPX</h2>
      <input type="file" id="gpxInput" accept=".gpx" multiple />
      <div id="messages"></div>
    </div>

    <div class="section">
      <h2>‚úÖ Rotas Dispon√≠veis</h2>
      <ul id="gpxList">
        <li style="color: #666; font-style: italic;">Nenhuma rota carregada ainda.</li>
      </ul>
    </div>

    <div class="section" style="height: 400px;">
      <div id="map" style="height: 100%;"></div>
    </div>

    <footer class="text-center">
      <p>Feito com ‚ù§Ô∏è por Everton Tezzon Ferreira</p>
    </footer>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-gpx/gpx.min.js"></script>
  <script>
    // Service Worker registration
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js').catch(err => {
        console.log('Service Worker registration failed:', err);
      });
    }

    // Initialize map
    let map = L.map('map').setView([-22.2171, -48.7173], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    const gpxFiles = [];
    let currentGpxLayer = null;

    // Get DOM elements
    const gpxInput = document.getElementById('gpxInput');
    const gpxList = document.getElementById('gpxList');
    const messages = document.getElementById('messages');

    function showMessage(text, type = 'info') {
      const messageDiv = document.createElement('div');
      messageDiv.className = type;
      messageDiv.textContent = text;
      messages.appendChild(messageDiv);
      
      setTimeout(() => {
        if (messageDiv.parentNode) {
          messageDiv.parentNode.removeChild(messageDiv);
        }
      }, 5000);
    }

    function speak(message) {
      if (!window.speechSynthesis) return;
      
      const utterance = new SpeechSynthesisUtterance(message);
      utterance.lang = 'pt-BR';
      
      // Wait for voices to be loaded
      const speakWhenReady = () => {
        const voices = window.speechSynthesis.getVoices();
        const brazilianVoice = voices.find(v => 
          v.lang.includes('pt-BR') || v.lang.includes('pt')
        );
        
        if (brazilianVoice) {
          utterance.voice = brazilianVoice;
        }
        
        window.speechSynthesis.speak(utterance);
      };
      
      if (window.speechSynthesis.getVoices().length > 0) {
        speakWhenReady();
      } else {
        window.speechSynthesis.addEventListener('voiceschanged', speakWhenReady, { once: true });
      }
    }

    function updateGPXList() {
      if (gpxFiles.length === 0) {
        gpxList.innerHTML = '<li style="color: #666; font-style: italic;">Nenhuma rota carregada ainda.</li>';
        return;
      }

      gpxList.innerHTML = '';
      gpxFiles.forEach((file, index) => {
        const item = document.createElement('li');
        item.className = 'list-item';
        
        const fileName = document.createElement('span');
        fileName.textContent = file.name;
        
        const loadButton = document.createElement('button');
        loadButton.className = 'btn';
        loadButton.textContent = 'Selecionar';
        loadButton.onclick = () => loadGPX(index);
        
        const removeButton = document.createElement('button');
        removeButton.className = 'btn';
        removeButton.style.background = '#e74c3c';
        removeButton.style.marginLeft = '10px';
        removeButton.textContent = 'Remover';
        removeButton.onclick = () => removeGPX(index);
        
        const buttonContainer = document.createElement('div');
        buttonContainer.appendChild(loadButton);
        buttonContainer.appendChild(removeButton);
        
        item.appendChild(fileName);
        item.appendChild(buttonContainer);
        gpxList.appendChild(item);
      });
    }

    function removeGPX(index) {
      gpxFiles.splice(index, 1);
      updateGPXList();
      showMessage('Arquivo removido com sucesso!', 'success');
    }

    function loadGPX(index) {
      if (!gpxFiles[index]) {
        showMessage('Arquivo GPX n√£o encontrado!', 'error');
        return;
      }

      const gpxContent = gpxFiles[index].content;
      
      // Remove previous layer
      if (currentGpxLayer) {
        map.removeLayer(currentGpxLayer);
      }

      try {
        // Create new GPX layer
        currentGpxLayer = new L.GPX(gpxContent, {
          async: true,
          marker_options: {
            startIconUrl: 'https://raw.githubusercontent.com/mpetazzoni/leaflet-gpx/master/pin-icon-start.png',
            endIconUrl: 'https://raw.githubusercontent.com/mpetazzoni/leaflet-gpx/master/pin-icon-end.png',
            shadowUrl: 'https://raw.githubusercontent.com/mpetazzoni/leaflet-gpx/master/pin-shadow.png',
          }
        });

        currentGpxLayer.on('loaded', function(e) {
          console.log('GPX loaded successfully');
          const bounds = e.target.getBounds();
          if (bounds.isValid()) {
            map.fitBounds(bounds);
          }
          
          showMessage('Rota carregada com sucesso!', 'success');
          speak('Rota carregada com sucesso.');
          
          // Try to enter fullscreen (only works with user interaction)
          if (document.documentElement.requestFullscreen) {
            document.documentElement.requestFullscreen().catch(err => {
              console.log('Fullscreen not available:', err);
            });
          }
        });

        currentGpxLayer.on('error', function(e) {
          console.error('GPX loading error:', e);
          showMessage('Erro ao carregar a rota GPX. Verifique se o arquivo √© v√°lido.', 'error');
        });

        currentGpxLayer.addTo(map);
        
      } catch (error) {
        console.error('Error processing GPX:', error);
        showMessage('Erro ao processar o arquivo GPX.', 'error');
      }
    }

    // File input handler
    gpxInput.addEventListener('change', (event) => {
      const files = Array.from(event.target.files);
      
      if (files.length === 0) return;
      
      let loadedCount = 0;
      let errorCount = 0;
      
      files.forEach(file => {
        if (!file.name.toLowerCase().endsWith('.gpx')) {
          showMessage(`Arquivo ${file.name} n√£o √© um GPX v√°lido.`, 'error');
          errorCount++;
          return;
        }

        const reader = new FileReader();
        
        reader.onload = (e) => {
          try {
            const content = e.target.result;
            
            // Basic GPX validation
            if (!content.includes('<gpx') && !content.includes('<?xml')) {
              throw new Error('Arquivo n√£o parece ser um GPX v√°lido');
            }
            
            // Check if file already exists
            const existingFile = gpxFiles.find(f => f.name === file.name);
            if (existingFile) {
              showMessage(`Arquivo ${file.name} j√° foi carregado.`, 'error');
              return;
            }
            
            gpxFiles.push({ 
              name: file.name, 
              content: content,
              size: file.size 
            });
            
            loadedCount++;
            updateGPXList();
            showMessage(`Arquivo ${file.name} carregado com sucesso!`, 'success');
            
          } catch (error) {
            console.error('Error reading file:', error);
            showMessage(`Erro ao ler o arquivo ${file.name}`, 'error');
            errorCount++;
          }
        };
        
        reader.onerror = () => {
          showMessage(`Erro ao ler o arquivo: ${file.name}`, 'error');
          errorCount++;
        };
        
        reader.readAsText(file);
      });
      
      // Clear the input
      event.target.value = '';
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && document.fullscreenElement) {
        document.exitFullscreen();
      }
    });

    console.log('GPX Navigator initialized successfully');
  </script>
</body>
</html>